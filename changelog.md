# Changelog

## 2025-03-28

### 切换到Azure OpenAI的GPT-4.5 preview模型（2025-03-28 14:40）

1. 更新核心配置
   - 修改config.ts，添加Azure OpenAI的完整配置
   - 配置Azure端点：https://y7948-m7dkvj9c-swedencentral.openai.azure.com/
   - 设置部署名称和模型名称：gpt-4.5-preview
   - 添加API版本：2024-04-01-preview

2. 客户端代码升级
   - 将所有OpenAI客户端替换为AzureOpenAI客户端
   - 更新chat-service.ts、chat.ts、openai.ts和openai-service.ts文件
   - 增强类型检查，确保类型安全

3. 模型调用参数优化
   - 添加max_tokens、temperature、top_p等参数
   - 根据Azure OpenAI的要求调整API调用
   - 将错误消息本地化为中文，提高用户体验
   - 将AI助手名称和说明本地化为中文

## 2025-03-17

### 优化文档节点生成逻辑（2025-03-17 20:50）

1. 改进文档节点连接关系
   - 修改文档节点生成逻辑，使绿色文档节点只连接到黄色上下文节点(context类型)
   - 优化文档内容生成过程，正确处理各种类型的节点内容
   - 增强文档节点的错误处理能力，防止因格式问题导致生成失败

2. 改进文档内容结构
   - 优化文档内容格式，增加节点关系描述
   - 自动处理JSON格式的内容，转换为可读的文本形式
   - 确保文档内容完整呈现所有节点和连接关系

## 2025-03-17

### 添加节点类型选择对话框功能（2025-03-17 17:34）

1. 创建节点类型选择对话框
   - 在工具栏中添加节点类型选择对话框
   - 支持选择创建四种不同类型的节点（上下文节点、外部服务节点、开发指南节点、文档节点）
   - 为不同类型节点添加对应的颜色样式

2. 实现节点创建功能
   - 根据用户选择的节点类型创建相应的节点
   - 添加节点位置计算逻辑，使新节点始终出现在视图中心
   - 为每种节点类型设置不同的默认标题

3. 修复类型检查错误
   - 导入和使用正确的NodeType类型
   - 修复组件之间的类型兼容性问题
   - 优化类型断言，确保类型安全

### 添加项目文档节点功能（2025-03-17 16:35）

1. 创建绿色文档节点
   - 新增`document`节点类型，用于整合其他三种节点的内容
   - 添加绿色文档节点的样式和翻译支持
   - 实现自动聚合连接节点内容的功能

2. 添加文档内容生成功能
   - 创建`document-generator.ts`工具文件处理文档生成逻辑
   - 实现根据节点类型自动分类整理内容
   - 生成完整的项目开发文档，包含项目介绍、产品功能、外部服务和开发指南

3. 增强节点交互功能
   - 添加文档刷新按钮，支持手动更新文档内容
   - 实现文档节点内容自动更新功能
   - 优化文档生成的类型检查和错误处理

## 2025-03-04

### 改进节点详情内容分组显示（2025-03-04 21:52）

1. 优化标题与内容的分组逻辑
   - 重构了内容分组算法，将相关内容放在同一个callout中
   - 在`node-details.tsx`中改进了渲染逻辑，确保标题与其子项内容在一起显示
   - 优化了内容组织结构，增强了文档的可读性
   - 解决了标题与子级内容分散显示的问题

### 修复节点内容格式化问题（2025-03-04 21:45）

1. 修复节点内容被包裹在大括号中的问题
   - 在`node-details.tsx`中添加JSON格式检测和处理逻辑
   - 实现自动提取JSON对象中的文本内容
   - 优化内容处理流程，确保正确显示节点详情
   - 解决所有内容混在一起的显示问题

## 2025-03-04

### 节点详情弹出页模块化改造（2025-03-04 21:30）

1. 创建Callout组件
   - 添加新的UI组件`components/ui/callout.tsx`
   - 支持多种样式变体，默认使用白灰色调
   - 提供标题和内容区域，增强视觉层次感
   - 修复导入路径，正确引用`@/lib/utils/common`中的`cn`函数

2. 改进节点详情展示
   - 重构`node-details.tsx`中的内容格式化逻辑
   - 将长文本内容分割为独立的Callout模块
   - 根据标题层级自动创建内容分组
   - 优化列表项和段落的视觉呈现

3. 进一步优化节点详情展示
   - 仅保留第一个标题作为function title，保持原有字体和字号
   - 将主干内容也包含在callout中，而不仅仅是小点
   - 使用白灰色调的callout替代蓝色
   - 统一使用较小的字体和字号，提高可读性
   - 避免重复显示主干部分的内容

### 添加UI语言与用户输入语言同步功能（2025-03-04 16:19）

1. 增强语言一致性
   - 在API响应中添加用户语言信息
   - 在前端接收到响应后自动更新UI语言
   - 确保节点标题和内容语言一致

### 修复类型检查错误（2025-03-04 16:07）

1. 增强类型检查和错误处理
   - 在调用`includes`方法前检查内容是否为字符串类型
   - 当发现非字符串类型时跳过后续检查，避免类型错误
   - 修改`detectLanguage`函数以支持非字符串输入

### 修复JSON解析错误（2025-03-04 16:04）

1. 修复重新生成内容的JSON解析问题
   - 正确处理validateJSON函数的返回值，它只返回验证结果而非解析后的JSON对象
   - 添加错误处理逻辑，当JSON验证或解析失败时使用原始结果继续
   - 增强日志记录，便于调试和排错

### 修复英文提示生成中文内容问题（2025-03-04 16:00）

1. 增强内容语言验证
   - 修复 `validateContentStructure` 函数中的语言检测逻辑，确保英文用户也能收到英文内容
   - 在 API 调用中添加对内容语言一致性的验证

2. 增强系统提示
   - 在提示模板中增加关于语言要求的强调
   - 在系统提示中添加用户语言信息

3. 添加内容重新生成机制
   - 当检测到语言不一致时，自动尝试重新生成内容
   - 使用增强的系统提示进行重新生成
   - 比较原始内容和重新生成的内容，选择语言一致性更好的结果

## 2025-03-03

### 清理未使用的 PDF 相关代码（2025-03-03 01:15）

1. 移除 PDF 存储相关代码
   - 移除了 prompt-node.tsx 和 results-panel.tsx 中对 pdf-store 的依赖
   - 重构了结果显示逻辑，不再依赖 PDF 文件信息

2. 清理 OpenAI 服务中的 PDF 功能
   - 移除了 chat-service.ts 中的 uploadPDFAndAttachToThread 函数
   - 移除了 openai.ts 和 openai-service.ts 中的 createVectorStore 和 uploadFileToVectorStore 函数
   - 更新了 createAssistant 函数，移除 PDF 相关的描述和工具



## 2025-02-20

### 修复 AI 返回内容被截断问题（2025-02-20 12:14）

1. 使用正确的 Azure OpenAI 参数
   - 使用 max_completion_tokens 而不是 max_tokens
   - 移除不支持的参数
2. 成功生成完整的流程图数据
   - 9 个节点（上下文、产品、外部服务）
   - 8 个连接边
   - 包含详细的描述和交互逻辑


## 2025-02-20

### 简化 AI 输出参数（2025-02-20 12:03）

1. 简化 Azure OpenAI 参数
   - 只保留 max_tokens 参数
   - 移除不支持的参数
   - 增加 token 限制至 100000


## 2025-02-20

### 优化 AI 输出参数（2025-02-20 12:00）

1. 调整 Azure OpenAI 参数
   - 增加 token 限制至 4000
   - 添加温度控制参数
   - 添加惩罚参数以降低重复内容


## 2025-02-20

### 增强 JSON 验证日志（2025-02-20 11:48）

1. 添加更多 JSON 处理日志
   - 记录原始 AI 响应内容
   - 记录清理前后的内容
   - 记录验证失败的具体原因


## 2025-02-20

### 增强调试日志（2025-02-20 11:42）

1. 添加更多调试日志
   - 记录 Azure OpenAI 配置信息
   - 记录 AI 响应详情
   - 移除默认配置值


## 2025-02-20

### 重构错误处理（2025-02-20 11:38）

1. 移动 APIError 类
   - 创建 lib/types/error.ts 文件
   - 将 APIError 类移动到独立的类型文件


## 2025-02-20

### 增强 JSON 处理（2025-02-20 11:36）

1. 增强 sanitizeJSON 函数
   - 移除代码块标记
   - 提取 JSON 部分
   - 移除注释
   - 修复更多 JSON 格式错误


## 2025-02-20

### 添加健康检查 API（2025-02-20 11:34）

1. 添加 /api/health 端点
   - 检查服务器状态
   - 测试 Azure OpenAI 连接


## 2025-02-20

### 修复 API 调用问题（2025-02-20 11:28）

1. 修复 Azure OpenAI 服务配置
   - 更新测试连接方法
   - 修复类型错误

2. 移除不支持的参数
   - 移除 temperature 参数
   - 更新测试脚本


## 2025-02-20

### 修复 API 参数错误（2025-02-20 11:25）

1. 更新 API 参数名称
   - 将 max_tokens 更改为 max_completion_tokens
   - 更新测试脚本中的参数


## 2025-02-20

### 修复 API 调用错误（2025-02-20 11:21）

1. 修复 generate-flow API 路由
   - 更新 chat completions API 调用方式
   - 添加 temperature 和 max_tokens 参数


## 2025-02-20

### 升级 Azure OpenAI SDK（2025-02-20 11:15）

1. 更新依赖
   - 删除 @azure/openai beta 版本
   - 安装 openai 稳定版

2. 更新代码
   - 更新 Azure OpenAI 配置和客户端初始化
   - 更新 API 调用方式
   - 更新测试脚本

3. 配置更新
   - 更新 API 版本为 2024-02-15-preview
   - 优化客户端配置方式


## 2025-02-20

### 清理依赖（2025-02-20 10:43）

1. 彻底清理依赖
   - 删除 node_modules 目录
   - 删除 package-lock.json
   - 重新安装所有依赖

2. 更新依赖版本
   - 确认 tailwindcss 为 3.4.1
   - 确认 postcss 为 8.4.35
   - 确认 autoprefixer 为 10.4.17


## 2025-02-20

### 修复 Tailwind CSS 配置问题（2025-02-20 10:40）

1. 更新依赖版本
   - tailwindcss 降级至 3.4.1
   - postcss 降级至 8.4.35
   - autoprefixer 降级至 10.4.17

2. 更新 PostCSS 配置
   - 添加 tailwindcss/nesting 插件
   - 优化插件加载顺序


## 2025-02-20

### 更新依赖版本（2025-02-20 10:37）

1. 更新项目层级的开发依赖
   - 更新 tailwindcss 及相关依赖到最新版本
   - 确保依赖安装在项目的 devDependencies 中


## 2025-02-20

### 配置 Tailwind CSS（2025-02-20 10:34）

1. 创建配置文件
   - 创建 tailwind.config.js
   - 配置主题和插件

2. 安装依赖
   - 安装 tailwindcss 及相关依赖
   - 安装 tailwindcss-animate 和 @tailwindcss/typography 插件


## 2025-02-20

### 简化消息处理逻辑（2025-02-20 10:33）

1. 简化消息类型定义
   - 移除复杂的消息类型定义
   - 使用简单的字符串类型

2. 简化消息处理逻辑
   - 使用 JSON.stringify 处理非字符串内容
   - 移除不必要的类型断言


## 2025-02-20

### 改进消息内容的类型处理（2025-02-20 10:30）

1. 修复 chat-store.ts 中的类型错误
   - 根据消息内容的 type 字段正确处理不同类型的内容
   - 添加对图片消息的支持
   - 优化代码可读性


## 2025-02-20

### 修复消息内容类型处理（2025-02-20 10:29）

1. 修复 chat-store.ts 中的类型错误
   - 改进消息内容的类型处理逻辑
   - 支持字符串、数组和对象类型的消息内容


## 2025-02-20

### 继续修复类型错误（2025-02-20 10:28）

1. 修复 chat-store.ts 中的类型错误
   - 添加 TextContentBlock 类型导入

2. 改进 PDF 文件类型
   - 在 PDFFile 接口中添加 title 属性
   - 修复 prompt-node.tsx 中的相关错误


## 2025-02-20

### 修复类型错误和依赖问题（2025-02-20 10:26）

1. 安装缺失的依赖
   - 添加 react-day-picker 包

2. 创建和修复类型定义
   - 创建 common.ts 类型定义文件
   - 添加 MessageContent 和相关类型
   - 修复 chat-store.ts 中的类型错误

3. 修复工具函数类型
   - 在 text-formatter.ts 中添加 Record 类型
   - 将 formatText 函数改为异步函数

4. 创建 PDF 存储
   - 创建 pdf-store.ts 文件
   - 实现 PDF 文件管理功能

5. 修复组件类型错误
   - 修复 prompt-node.tsx 中的类型错误
   - 修复 results-panel.tsx 中的类型错误和空值检查


## 2025-02-20

### 修复 flow-canvas 组件的导入和类型错误（2025-02-20 10:16）

1. 修复导入路径
   - 添加 React 导入
   - 更新组件导入路径
   - 添加缺失的依赖

2. 修复类型错误
   - 添加 ReactFlowNode 类型别名
   - 修复节点类型转换问题

## 2025-02-20

### 清理项目中的重复和未使用的代码（2025-02-20 10:14）

1. 删除重复的组件文件
   - 删除旧版本的 flow-canvas.tsx 和 flow-toolbar.tsx
   - 删除旧版本的 prompt-node.tsx

2. 清理未使用的 API 路由
   - 删除旧版本的 generate 路由
   - 删除未使用的 test-openai 路由

## 2025-02-20

### 移除未使用的 PDF 上传功能（2025-02-20 10:04）

1. 代码清理
   - 移除 PDFUpload 组件和相关代码
   - 清理不必要的导入语句
   - 优化组件结构

## 2025-02-20

### 添加 PDF 上传组件和修复类型错误（2025-02-20 10:03）

1. 添加新组件
   - 创建 PDF 上传组件
   - 支持文件选择和上传功能
   - 添加基本的错误处理

2. 类型错误修复
   - 修复 Node 类型不匹配问题
   - 添加类型断言以确保类型安全

## 2025-02-20

### 修复流程图画布组件类型错误（2025-02-20 10:01）

1. 依赖更新
   - 将 react-flow-renderer 更新为 reactflow
   - 修复类型导入和使用

2. 类型定义优化
   - 在 Node 接口中添加 prompt 和 result 字段
   - 在 FlowState 接口中添加 updateNodePrompt 和 updateNodeResult 方法
   - 添加缺失的类型注解

3. 组件改进
   - 修复组件导入路径
   - 优化类型检查和错误处理
   - 改进代码可读性

## 2025-02-20

### 优化生成流程图路由和类型定义（2025-02-20 09:32）

1. 优化 route.ts 文件
   - 移除中文注释和示例代码
   - 改进错误处理和类型检查
   - 优化代码结构和可读性
   - 统一使用英文错误消息

2. 更新类型定义
   - 在 GeneratedEdge 接口中添加 description 字段
   - 确保类型安全和完整性

## 2025-02-20

### 修复生成流程图路由的类型错误（2025-02-20 10:16）

1. 修复类型导入
   - 删除重复的接口定义
   - 添加缺失的 NodeType 类型导入
   - 使用完整的类型导入路径

2. 代码结构优化
   - 删除未使用的代码
   - 修复语法错误
   - 改进代码格式和缩进

## 2025-02-20

### 重构生成流程图路由（2025-02-20 10:00）

1. 代码结构优化
   - 将 SYSTEM_PROMPT 移动到单独的 lib/prompts/flow-generation.ts 文件
   - 使用新的配置管理和错误处理模块
   - 简化 JSON 处理和验证逻辑

2. 错误处理改进
   - 统一使用 handleAPIError 处理所有错误
   - 添加更详细的错误信息
   - 优化错误状态码返回

3. 代码可维护性提升
   - 减少代码重复
   - 提高代码可读性
   - 优化文件组织结构

## 2025-02-19

### 修复生成流程图路由（2025-02-19 21:47）

1. 配置更新
   - 使用硬编码的端点地址
   - 使用硬编码的部署名称
   - 统一 API 版本

2. 代码优化
   - 移除重复的 apiVersion 定义
   - 在请求时初始化客户端
   - 添加详细的日志

### Azure OpenAI 测试成功（2025-02-19 21:46）

1. 连接测试
   - 成功连接到 Azure OpenAI 服务
   - API 认证通过
   - 模型响应正常

2. 配置确认
   - 端点配置正确
   - API 版本兼容
   - 部署名称有效

### 简化 Azure OpenAI 请求参数（2025-02-19 21:45）

1. 参数简化
   - 移除 temperature 参数
   - 移除 maxCompletionTokens 参数
   - 只保留必要的请求参数

2. 兼容性优化
   - 适配模型特性
   - 减少可能的错误点

### 更新 Azure OpenAI 参数名称（2025-02-19 21:43）

1. 参数更新
   - 将 maxTokens 更改为 maxCompletionTokens
   - 更新测试端点和主路由

2. 兼容性修复
   - 适配新版本 API 参数要求
   - 保持其他参数不变

### 使用硬编码配置进行测试（2025-02-19 21:42）

1. 配置更新
   - 使用硬编码的端点地址
   - 使用硬编码的部署名称
   - 保持原有的 API 密钥

2. 调试信息
   - 添加更详细的配置日志
   - 显示完整的端点信息

### 更新 Azure OpenAI 端点配置（2025-02-19 21:39）

1. 更新 API 版本
   - 使用 2024-12-01-preview
   - 添加 apiVersion 到客户端配置

2. 端点配置优化
   - 构建完整的端点 URL
   - 移除不必要的密钥格式验证

### 增强 Azure OpenAI 配置验证（2025-02-19 21:37）

1. 配置验证
   - 检查 Endpoint 格式
   - 验证 API 密钥长度和格式
   - 检查部署名称

2. 调试信息增强
   - 显示 API 密钥长度
   - 检查密钥格式是否有效
   - 安全显示密钥前后片段

### 添加 Azure OpenAI 测试端点（2025-02-19 21:34）

1. 新增测试端点
   - 添加 /api/test-openai 路由
   - 实现配置测试功能
   - 提供详细的状态反馈

2. 调试功能
   - 打印完整的配置信息
   - 测试 API 连接性
   - 安全处理敏感信息

### 优化 Azure OpenAI 配置和错误处理（2025-02-19 21:32）

1. API 配置优化
   - 使用固定的 API 版本
   - 简化客户端初始化
   - 添加详细的调试日志

2. 错误处理增强
   - 改进错误类型检测
   - 使用正确的 HTTP 状态码
   - 提供更详细的调试信息

### 增强 Azure OpenAI 错误处理（2025-02-19 21:30）

1. 身份验证错误检测
   - 添加特定错误类型检测
   - 打印详细的配置信息

2. 错误响应增强
   - 包含当前配置状态
   - 安全处理敏感信息

### 修复 OpenAI 客户端类型问题（2025-02-19 21:28）

1. 修复 Azure OpenAI 调用参数
   - 移除不支持的 model 参数
   - 修改请求选项类型

2. 修复 OpenAI 客户端类型
   - 修复 model 参数类型问题
   - 添加默认值处理

### Azure OpenAI API 请求优化（2025-02-19 21:26）

1. 客户端配置优化
   - 使用变量存储配置信息
   - 添加 apiVersion 到客户端配置
   - 添加 model 参数到请求选项

2. 调试信息增强
   - 打印完整的 API 请求 URL
   - 优化配置信息显示
   - 安全处理敏感信息

### Azure OpenAI API 配置简化（2025-02-19 21:18）

1. 简化 API 配置
   - 移除多余的 URL 构建逻辑
   - 简化客户端初始化
   - 移除重复的 API 版本参数

2. 调试信息优化
   - 添加更清晰的配置日志
   - 打印部署名称信息
   - 安全处理 API 密钥显示

### Azure OpenAI API 错误处理增强（2025-02-19 21:18）

1. 调试信息增强
   - 添加详细的环境变量检查
   - 增加请求和响应日志
   - 优化错误消息格式

2. 错误处理改进
   - 增加 API 调用异常捕获
   - 优化错误返回格式
   - 修复变量作用域问题

### Azure OpenAI API URL 结构优化（2025-02-19 21:16）

1. API URL 结构优化
   - 使用完整的 API URL 路径
   - 添加详细的调试日志
   - 简化客户端初始化配置

### Azure OpenAI API 端点配置修复（2025-02-19 21:14）

1. 端点配置修复
   - 确保 endpoint URL 以斜杠结尾
   - 移除重复的 deploymentName 参数
   - 优化 OpenAI 客户端初始化

### Azure OpenAI API 配置修复（2025-02-19 21:13）

1. API 调用修复
   - 更新 OpenAI 客户端初始化配置，添加 apiVersion
   - 修复 getChatCompletions 调用参数
   - 添加 deploymentName 到请求选项

## 2025-02-19

### Azure OpenAI API 集成更新（2025-02-19 21:08）

1. 配置更新
   - 添加 AZURE_OPENAI_API_VERSION 环境变量
   - 创建新的 config.ts 文件管理 Azure OpenAI 配置
   - 完善配置验证逻辑

2. API 集成改进
   - 更新 OpenAI 客户端配置以支持 Azure OpenAI
   - 修复 ChatCompletion 类型定义问题
   - 优化错误处理和提示信息

## 2025-02-15

### 添加 TypeScript 类型定义（2025-02-15 12:01）

1. 类型安全

   - 添加 AINode 接口，定义节点结构
   - 添加 AIEdge 接口，定义边结构
   - 使用类型注解确保类型安全

2. 代码质量
   - 消除 TypeScript 类型错误
   - 改进代码可维护性

### 改进 AI 响应处理（2025-02-15 11:54）

1. 数据验证和转换

   - 添加节点数据完整性验证
   - 添加边数据完整性验证
   - 实现数据格式转换逻辑

2. 错误处理

   - 添加详细的错误信息
   - 改进错误日志记录

3. 性能优化
   - 使用 Math.round 优化坐标值
   - 简化数据结构

## 2025-02-13

### 优化节点详情面板（2025-02-14 00:41）

1. 改进设计

   - 添加半透明遮罩层
   - 使用不透明背景
   - 点击遮罩层可关闭

2. 优化滚动交互
   - 阻止滚轮事件传播到画布
   - 使用 sticky 头部
   - 优化滚动区域高度

### 优化节点显示方式（2025-02-14 00:35）

1. 新增节点详情面板

   - 创建 NodeDetails 组件
   - 支持在侧边栏查看完整内容
   - 使用滚动区域显示长内容

2. 简化节点卡片
   - 减小卡片宽度为 300px
   - 只显示标题和简要信息
   - 添加“查看详情”按钮

### 修复生成内容格式（2025-02-14 00:29）

1. 修复语法错误

   - 移除了 Markdown 代码块格式
   - 使用编号列表替代 Markdown 标题
   - 使用缩进替代嵌套列表

2. 优化内容结构
   - 使用数字和字母编号
   - 使用缩进表示层级关系
   - 简化了样式描述
   - 合并了相似的字段

### 优化 AI 生成内容（2025-02-14 00:26）

1. 完善节点内容描述

   - 采用结构化的 Markdown 格式
   - 添加详细的页面描述部分
   - 添加完整的 UI 组件描述
   - 添加数据结构和交互逻辑
   - 添加 API 集成和性能优化
   - 添加异常处理和扩展性设计

2. 完善节点连接描述
   - 添加跳转触发条件说明
   - 添加数据传递细节
   - 添加状态变化说明
   - 添加异常处理和回退策略

### 全面项目优化（2025-02-14 00:04）

1. 降级 TypeScript 版本

   - 从 5.2.2 降级到 5.1.6
   - 解决与 @typescript-eslint/typescript-estree 的兼容性问题

2. 完善项目文档

   - 更新 README.md，添加详细的项目说明
   - 添加功能特点、技术栈、安装配置等信息
   - 完善项目结构说明

3. 完善环境配置
   - 更新 .env.example，添加详细的配置说明
   - 添加更多环境变量选项
   - 添加中文注释说明

### 修复安全漏洞（2025-02-13 23:54）

1. 更新主要依赖包

   - 更新 next.js 到 15.1.7
   - 更新 postcss 到 8.4.31
   - 更新 zod 到 3.22.3

2. 修复的漏洞
   - 修复 Next.js 服务器端请求伪造和缓存中毒问题
   - 修复 PostCSS 行返回解析错误
   - 修复 Zod 拒绝服务漏洞

### 添加依赖包（2025-02-13 23:53）

1. 安装 react-markdown 包
   - 添加 react-markdown 依赖
   - 包含 TypeScript 类型定义

### 修复文件引用问题（2025-02-13 23:50）

1. 修复 UI 组件中的引用
   - 更新 components/ui 中的 utils 引用
   - 更新 components/chat 中的类型引用
   - 更新 components/chat 中的工具函数引用

### 修复文件引用（2025-02-13 23:49）

1. 修复文件移动后的引用问题

   - 更新工具函数引用到 utils/common
   - 更新类型定义引用到 types/common
   - 更新服务引用到 services/

2. 添加修复脚本
   - 创建 scripts/fix-imports.sh
   - 自动更新所有 TypeScript 文件

### 优化项目结构（2025-02-13 23:47）

1. 整理项目目录结构

   - 统一类型定义到 /lib/types/ 目录
   - 统一服务文件到 /lib/services/ 目录
   - 统一工具函数到 /lib/utils/ 目录

2. 移动文件
   - 移动 types.ts 到 types/common/index.ts
   - 移动 chat-service.ts 到 services/chat.ts
   - 移动 openai-service.ts 到 services/openai.ts
   - 移动 utils.ts 到 utils/common.ts

### 进一步增加节点间距（2025-02-13 23:41）

1. 显著增加节点间距
   - 主流程间距从 400 像素增加到 600 像素
   - 行间距从 200 像素增加到 300 像素
   - 最小节点间距从 200 像素增加到 300 像素
   - 起始位置从 (100, 100) 移动到 (200, 200)

### 优化节点布局规则（2025-02-13 23:38）

1. 优化节点布局策略
   - 增加节点间距为 400 像素
   - 增加行间距为 200 像素
   - 增加最小节点间距为 200 像素
   - 优化节点分布规则

### 进一步优化存储空间（2025-02-13 23:27）

1. 优化数据清理函数
   - 减少历史记录的保留数量
   - 四舍五入节点坐标
   - 移除节点中的多余字段
   - 优化字符串存储

### 优化节点 ID 系统（2025-02-13 23:24）

1. 优化节点标识符系统
   - 使用节点标题作为唯一标识符
   - 移除多余的 ID 字段
   - 优化节点映射逻辑

### 修复类型错误（2025-02-13 23:21）

1. 修复节点数据类型
   - 保留节点的 draggable 属性
   - 修复节点清理函数
   - 修复类型不匹配问题

### 优化数据存储（2025-02-13 23:19）

1. 全面优化数据存储

   - 在所有更新函数中使用数据清理
   - 移除节点中不必要的字段
   - 优化历史记录的存储方式

2. 优化操作函数
   - 优化撤销和重做函数
   - 优化节点更新函数
   - 优化连接线更新函数

### 优化节点布局（2025-02-13 23:16）

1. 优化节点布局规则

   - 主要流程从左到右排列
   - 并行功能从上到下排列
   - 上下文节点始终在最上方
   - 外部服务节点始终在最右边

2. 优化节点间距
   - 每列间距 300 像素
   - 每行间距 150 像素
   - 起始点从 (100, 100) 开始

### 修复连接线问题（2025-02-13 23:11）

1. 修复节点 ID 映射逻辑
   - 使用 API 返回的原始节点 ID 作为映射键
   - 修复连接线不显示的问题
   - 保持节点之间的正确连接

### 优化存储空间（2025-02-13 23:08）

1. 优化历史记录存储

   - 限制历史记录数量为 20 条
   - 自动清理过旧的历史记录
   - 保留当前状态和最近的操作

2. 优化节点数据
   - 移除不必要的数据字段
   - 减少存储空间占用
   - 保持必要的功能数据

### 节点交互优化（2025-02-13 23:07）

1. 修复连接线问题

   - 统一使用 bezier 类型的连接线
   - 移除虚线样式，使用实线
   - 优化线条粗细和颜色

2. 优化连接线样式
   - 使用更稳定的贝塞尔曲线
   - 保持美观的箭头标记
   - 优化选中状态的视觉反馈

### 节点交互优化（2025-02-13 23:04）

1. 修复连接线样式不一致的问题

   - 在生成流程图时也使用相同的连接线样式
   - 统一使用 smoothstep 类型的连接线
   - 保持一致的箭头标记和样式

2. 优化连接线样式
   - 默认使用虚线和箭头
   - 使用统一的线条粗细
   - 保持一致的选中样式

### 节点交互优化（2025-02-13 23:01）

1. 统一连接线样式

   - 使用 smoothstep 类型的连接线
   - 优化了连接线的粗细和颜色
   - 添加了美观的箭头标记

2. 优化连接线交互
   - 默认使用虚线样式
   - 选中时变为实线并加粗
   - 使用主色调标记选中状态

### 节点交互优化（2025-02-13 22:55）

1. 优化节点连接

   - 简化了连接点的设计，只保留左右两个连接点
   - 左侧作为输入点（target）
   - 右侧作为输出点（source）

2. 优化代码结构
   - 移除了重复的代码
   - 修复了类型错误
   - 清理了未使用的代码

### 节点交互优化（2025-02-13 22:10）

1. 连接线样式

   - 增加了连接线的粗细度（3px）
   - 优化了选中状态的显示，使用主色调和加粗（4px）
   - 增大了箭头指示器的尺寸

2. 节点连接点
   - 简化了连接点，只保留左右两侧
   - 左侧仅作为输入点，右侧仅作为输出点
   - 调整了连接点的位置，使其更容易点击

### 节点交互优化（2025-02-13 21:23）

1. 节点连接

   - 添加了左右两侧的连接点
   - 优化了连接线的样式，使用平滑曲线
   - 增加了箭头指示连接方向
   - 防止重复连接相同的节点

2. 交互优化
   - 连接点悬停时会放大显示
   - 支持使用 Delete 或 Backspace 删除节点和连接
   - 支持 Shift 多选节点
   - 使用松散连接模式，更灵活的连线方式

### 界面布局优化（2025-02-13 21:18）

1. 页面布局

   - 使画布充满整个屏幕
   - 将控制面板改为悬浮在画布上方
   - 添加了模糊背景效果

2. FlowCanvas 组件
   - 优化了画布尺寸计算
   - 改进了视图重置功能
   - 调整了默认缩放级别

## 2025-02-13

### API 错误处理优化（2025-02-13 18:40）

1. generate-flow/route.ts
   - 使用更智能的 JSON 提取方法，直接定位对象开始和结束位置
   - 增加了响应格式验证，确保 JSON 对象包含必要的字段
   - 改进了错误消息，提供更精确的问题描述

### API 错误处理优化（2025-02-13 18:34）

1. generate-flow/route.ts
   - 改进了 JSON 解析逻辑，增加了空响应检查
   - 添加了更详细的日志记录，便于调试
   - 优化了错误消息的处理和返回
   - 增加了对代码块包裹的 JSON 响应的处理

### Next.js 配置修复（2025-02-13 18:34）

1. next.config.js
   - 移除了 `output: 'export'` 配置，以支持动态 API 路由
   - 保留了图片、ESLint 和 TypeScript 相关配置

### API 路由修复（2025-02-13 18:31）

1. generate-flow/route.ts 和 generate/route.ts
   - 添加了 `dynamic = 'force-dynamic'` 配置以禁用静态生成
   - 将 `runtime` 从 'edge' 改为 'nodejs' 以解决兼容性问题
   - 添加了 `preferredRegion = 'auto'` 配置以优化路由性能
   - 解决了 `NEXT_STATIC_GEN_BAILOUT` 和 404 错误

### API 路由修复（2025-02-13 18:31）

1. generate-flow/route.ts 和 generate/route.ts
   - 添加了 `dynamic = 'force-dynamic'` 配置以禁用静态生成
   - 添加了 `runtime = 'edge'` 配置以使用边缘运行时
   - 解决了 `NEXT_STATIC_GEN_BAILOUT` 错误

### TypeScript 类型修复（2025-02-13 18:18）

1. flow-canvas.tsx
   - 使用类型断言来解决 `applyNodeChanges` 函数与 `nodes` 类型不匹配的问题
   - 确保返回的节点数组符合预期类型

### TypeScript 类型修复（2025-02-13 18:17）

1. flow-node.tsx

   - 修改了 `FlowNode` 组件的导出方式，使其兼容 ReactFlow 的 `NodeTypes` 类型要求
   - 使用类型断言确保类型安全

2. route.ts (generate)
   - 添加了空值合并操作符来处理可能为 null 的 API 密钥
   - 增加了消息内容类型检查，确保只处理文本类型的内容

### TypeScript 类型修复（2025-02-13 18:14）

1. route.ts

   - 修复了 `parseError` 的类型处理，添加了类型检查以安全访问 `message` 属性

2. flow-canvas.tsx

   - 添加了必要的类型导入（NodeProps, NodeTypes）
   - 修复了 `nodeTypes` 的类型注解

3. flow-node.tsx
   - 创建了 `FlowNodeData` 接口来定义节点数据结构
   - 修改了 `FlowNodeProps` 接口以继承 `NodeProps<FlowNodeData>`
   - 优化了类型定义，移除了重复的属性

这些修改提高了代码的类型安全性，并解决了所有的 TypeScript 编译错误。

### 功能更新

- 集成 Azure OpenAI 服务替代原有的 OpenAI 服务
- 添加提示词输入框组件
- 新增三种节点类型：产品流程（白色）、外部资源（蓝色）、上下文（黄色）
- 配置 Azure OpenAI 环境变量

### 代码重构

- 重构流程图画布组件，支持新的节点类型
- 更新节点组件样式和内容结构
- 移除 PDF 相关功能和组件
- 移除旧的节点类型和工具栏
- 移除 Python 虚拟环境（项目完全使用 Node.js）

### 调试优化

- 添加详细的错误日志记录
- 添加环境变量检查日志
- 改进错误响应格式，包含更多详细信息

### API 更新

- 使用 Azure OpenAI SDK 替代原有的 fetch 调用
- 添加更详细的错误日志记录
- 优化错误响应格式

### 依赖更新

- 添加 `encoding` 包以支持 fetch 功能
- 添加 `@azure/openai` 包以支持 Azure OpenAI 服务
- 添加 `next-themes` 包以支持主题切换

### 注意事项

- Azure OpenAI SDK 显示废弃警告，未来需要更新到最新的稳定版本
- npm 安装过程中出现了一些警告和漏洞提示，建议后续进行修复
